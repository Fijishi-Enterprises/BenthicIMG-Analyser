{% extends "images/base_source.html" %}
{% load thumbnail %}
{% load guardian_tags %}
{% load common_tags %}

{% block title %}{{ source.name }} - Browse Patches | CoralNet{% endblock %}
{% block js-includes %}
  {% include "javascript-includes.html" with jquery_ui="yes" %}
{% endblock %}

{% block page-specific-includes %}
  {% include "static-local-include.html" with type="js" path="js/ImageSearchHelper.js" %}

  {% include "static-local-include.html" with type="css" path="css/browse.css" %}
{% endblock %}

{% block content %}

  <legend>Browse Patches</legend>

  <div class="tutorial-message">
    {% include "visualization/help_browse.html" %}
  </div>

  {# Search form #}
  <div id="search-form-box" class="box">
    <form action="" method="post" id="search-form">
      {% csrf_token %}

      {% with image_form=image_search_form patch_form=patch_search_form %}

        {% for field in image_form.metadata_choice_fields %}
          {# Put label+field in a div to ensure they stay on the same line. #}
          <div style="display: inline-block">
            {{ field.label }}: {{ field }} </div>
        {% endfor %}
        <br/>
        {{ image_form.date_filter.label }}: {{ image_form.date_filter }}
        {{ image_form.image_name.label }}: {{ image_form.image_name }}
        {# Hidden field #}
        {{ image_form.image_form_type }}
        <br/>
        {{ patch_form.label.label }}: {{ patch_form.label }}
        {{ patch_form.annotation_status.label }}:
          {{ patch_form.annotation_status }}
        {{ patch_form.annotator.label }}: {{ patch_form.annotator }}

      {% endwith %}

      <div class="submit_button_wrapper_center">
        <input type='submit' value="Search">
      </div>
    </form>
  </div>

  {% if page_results.paginator.count == 0 %}
    {{ empty_message }}
  {% else %}

    {% get_obj_perms user for source as 'source_perms' %}

    {# Grid of patches #}
    {% for patch in patches %}
      <span class="thumb_wrapper">

        {% if 'source_edit' in source_perms %}
          <a href="{% url 'annotation_tool' patch.image.pk %}">
            <img class="thumb"
                 src="{{ patch.thumbnail_url }}"
                 title="Point {{ patch.point_number }} ({{ patch.row }},{{ patch.col }}) in: {{ patch.image.get_image_element_title }}"/>
          </a>
        {% else %}
          <a href="{% url 'image_detail' patch.image.pk %}">
            <img class="thumb"
                 src="{{ patch.thumbnail_url }}"
                 title="Point {{ patch.point_number }} ({{ patch.row }},{{ patch.col }}) in: {{ patch.image.get_image_element_title }}"/>
          </a>
        {% endif %}

      </span>
    {% endfor %}

    {# Pagination info and links #}
    {% include 'pagination_links.html' with use_post_form=True hidden_form=hidden_image_and_patch_form page_results=page_results %}
  {% endif %}

  {# Script in the body will run on page load. #}
  <script type="text/javascript">
    ImageSearchHelper.init();
  </script>

{% endblock %}
